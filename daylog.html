<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¯¸ë‚˜ì˜ í•˜ë£¨ê¸°ë¡ </title>
  <style>
    :root { --b:#e5e7eb; --bg:#ffffff; --muted:#6b7280; --card:#f9fafb; --ink:#111827; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
           background:var(--bg); color:var(--ink); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .topbar{
      position: sticky; top: 0; z-index: 20;
      background: rgba(255,255,255,0.98);
      backdrop-filter: saturate(180%) blur(10px);
      border-bottom: 1px solid var(--b);
      padding: 10px 0;
      margin: -16px -16px 12px;
      padding-left: 16px; padding-right: 16px;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { font-size: 13px; padding: 10px 12px; border:1px solid var(--b); border-radius:999px; background:#fff; }
    .pill strong { font-weight:800; }
    button { border:1px solid var(--b); background:#fff; border-radius:12px; padding:10px 12px; font-size:14px; cursor:pointer; min-height:44px; }
    button.primary{ background:var(--ink); color:#fff; border-color:var(--ink); }
    button.danger{ background:#fff; color:#b91c1c; border-color:#fecaca; }
    .card { border:1px solid var(--b); border-radius:14px; background:var(--card); padding:12px; }
    .hint { font-size:12px; color:var(--muted); line-height:1.5; margin-top:6px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 4px; }
    table { width:100%; border-collapse:collapse; margin-top:14px; font-size:13px; }
    th, td { border:1px solid var(--b); padding:8px; vertical-align:top; }
    th { background:#f3f4f6; text-align:left; }
    td { background:#fff; }
    .right { text-align:right; }

    /* Modal */
    .modal-back { position:fixed; inset:0; background:rgba(17,24,39,.48); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal { width:min(860px, 100%); background:#fff; border-radius:16px; border:1px solid var(--b); padding:14px; }
    .modal h2 { font-size:16px; margin:0 0 8px; }
    .grid { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 860px){ .grid{ grid-template-columns: 1fr 1fr 1fr; } }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    textarea { width:100%; height: 110px; resize: vertical; border:1px solid var(--b); border-radius:12px; padding:10px; font-size:14px; background:#fff; outline:none; }
    textarea:focus{ box-shadow: 0 0 0 3px rgba(59,130,246,.15); border-color:#93c5fd; }
    .mini { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .mini input[type="time"]{ border:1px solid var(--b); border-radius:12px; padding:10px; min-height:44px; font-size:14px; }
    .mini label{ margin:0; font-size:13px; color:var(--ink); }

    /* Mobile: stacked label/value per row */
    @media (max-width: 640px){
      .pill{ width:100%; }
      .row button{ width:100%; }
      .btns button{ width:100%; }
      table thead{ display:none; }
      table, tbody, tr{ display:block; width:100%; }
      tr{ margin:10px 0; border:1px solid var(--b); border-radius:12px; overflow:hidden; }
      td{
        display:flex;
        gap:10px;
        border:none;
        border-bottom:1px solid var(--b);
        padding:10px;
      /* widen-content (mobile): ë‚´ìš© ì¹¸ ê°€ë¡œí­ 1/3 ì¦ê°€ */
      td[data-label="ë‚´ìš©"]::before{ flex:0 0 60px; }

      }
      td:last-child{ border-bottom:none; }
      td::before{
        content: attr(data-label);
        flex:0 0 92px;
        font-size:12px;
        color:var(--muted);
        font-weight:800;}
      .right{ text-align:left; }
    }
  
    /* iPhone Bottom Sheet Popup for ê¸°ë¡ (minimal change) */
    body.modal-open { overflow: hidden; }
    @media (max-width: 640px){
      .modal-back{
        align-items: flex-end !important;
        justify-content: center !important;
        padding: 0 !important;
        padding-bottom: env(safe-area-inset-bottom) !important;
      }
      .modal{
        width: 100% !important;
        border-radius: 18px 18px 0 0 !important;
        max-height: 88vh !important;
        overflow: hidden !important;
        border-left: none !important;
        border-right: none !important;
        border-bottom: none !important;
      }
      .modal .sheet-scroll{
        max-height: 88vh;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
      .modal .sheet-head{
        position: sticky;
        top: 0;
        z-index: 5;
        background: rgba(255,255,255,0.98);
        backdrop-filter: saturate(180%) blur(10px);
        border-bottom: 1px solid var(--b);
        padding: 12px 12px 10px;
      }
      .modal .sheet-body{
        padding: 12px;
      }
      .modal .sheet-foot{
        position: sticky;
        bottom: 0;
        z-index: 5;
        background: rgba(255,255,255,0.98);
        border-top: 1px solid var(--b);
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      }
      .modal textarea{ height: 160px; }
      .modal .btns button{ width: 100%; }
    }


    /* ê¸°ë¡ ì…ë ¥ íƒ­ UI (ëª¨ë‹¬ ë‚´ë¶€) */
    .tabs { display:flex; gap:8px; }
    .tabbtn{
      flex:1 1 0;
      border:1px solid var(--b);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      min-height:44px;
      cursor:pointer;
    }
    .tabbtn.active{
      background: var(--ink);
      color:#fff;
      border-color: var(--ink);
    }
    .tabpane{ display:none; }
    .tabpane.active{ display:block; }
    .tabpane .card{ background: var(--card); }
    @media (max-width: 640px){
      .modal textarea{ height: 220px; } /* í•œ í™”ë©´ì— ì…ë ¥ ì§‘ì¤‘ */
    }


    /* iOS-style header */
    .ios-topbar{position:sticky;top:0;z-index:60;background:rgba(255,255,255,.86);backdrop-filter:saturate(180%) blur(18px);-webkit-backdrop-filter:saturate(180%) blur(18px);border-bottom:1px solid rgba(0,0,0,.06);padding:calc(10px + env(safe-area-inset-top)) 16px 12px;margin:-16px -16px 14px;}
    .ios-topbar .row1{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .ios-brand{display:flex;align-items:center;gap:10px;min-width:0;}
    .ios-icon{width:34px;height:34px;border-radius:11px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#4b4be0,#8b5cf6);color:#fff;box-shadow:0 8px 24px rgba(75,75,224,.18);flex:0 0 auto;font-size:18px;}
    .ios-titlewrap{min-width:0;}
    .ios-title{font-size:22px;font-weight:900;letter-spacing:-.02em;margin:0;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .ios-sub{margin-top:4px;font-size:12px;color:rgba(0,0,0,.55);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .ios-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.9);box-shadow:0 6px 18px rgba(0,0,0,.06);flex:0 0 auto;font-weight:800;}
    .ios-chip .dot{width:8px;height:8px;border-radius:99px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.18);}
    .ios-chip .label{font-size:13px;color:#111;}



/* page-padding */
:root{ --page-pad: 12px; } /* ì•½ 0.5cm ëŠë‚Œ */
html, body{ height:100%; }
body{
  padding: var(--page-pad);
  box-sizing: border-box;
  padding-top: calc(var(--page-pad) + env(safe-area-inset-top));
  padding-right: calc(var(--page-pad) + env(safe-area-inset-right));
  padding-bottom: calc(var(--page-pad) + env(safe-area-inset-bottom));
  padding-left: calc(var(--page-pad) + env(safe-area-inset-left));
}
*, *:before, *:after{ box-sizing: border-box; }

/* action-buttons-inline */
td[data-label="ì‘ì—…"]{ white-space: nowrap; }
td[data-label="ì‘ì—…"] button{
  display: inline-block;
  padding: 8px 10px;
  font-size: 14px;
  border-radius: 12px;
}
td[data-label="ì‘ì—…"] button + button{ margin-left: 8px; 
      /* width-tuning */
      td[data-label="ì‹œì‘"]::before,
      td[data-label="ì¢…ë£Œ"]::before{
        flex: 0 0 56px; /* ì‹œì‘/ì¢…ë£Œ ë¼ë²¨ ë” ì¢ê²Œ */
      }
      td[data-label="ë‚´ìš©"]::before{
        flex: 0 0 20%;   /* ë¼ë²¨ 1/5 */
        max-width: 20%;
      }

}

/* action-btn-height */
td[data-label="ì‘ì—…"] button{
  padding-top: 5px !important;
  padding-bottom: 5px !important; /* ì„¸ë¡œ ì‚¬ì´ì¦ˆ ì•½ 1/3 ì¤„ì„ */
}

/* force-desktop-table-on-mobile */
@media (max-width: 640px){
  table thead{ display: table-header-group !important; }
  table{ display: table !important; width: 100% !important; }
  tbody{ display: table-row-group !important; width: auto !important; }
  tr{ display: table-row !important; margin: 0 !important; border: none !important; border-radius: 0 !important; overflow: visible !important; }
  th, td{ display: table-cell !important; }
  td{
    gap: 0 !important;
    border: 1px solid var(--b) !important;
    padding: 10px !important;
  }
  td::before{ content: none !important; display:none !important; }
  /* ì‘ì€ í™”ë©´ì—ì„œ ê°€ë¡œë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
  .card, .panel{ overflow-x: auto; -webkit-overflow-scrolling: touch; }
}

/* duration-nowrap */
td[data-label="ì†Œìš”"]{ white-space: nowrap; }

/* start-end-tight */
td[data-label="ì‹œì‘"], td[data-label="ì¢…ë£Œ"]{
  padding-right: 6px !important; /* ì˜¤ë¥¸ìª½ ì—¬ë°± ì¤„ì—¬ì„œ ì™¼ìª½ê³¼ ê· í˜• */
}

/* start-end-tight-v2 */
td[data-label="ì‹œì‘"], td[data-label="ì¢…ë£Œ"]{
  padding-left: 6px !important;
  padding-right: 6px !important; /* ì™¼ìª½ê³¼ ë™ì¼í•˜ê²Œ ì¢ê²Œ */
  text-align: left !important;
}
td[data-label="ì‹œì‘"], td[data-label="ì¢…ë£Œ"]{
  width: 1% !important;
  white-space: nowrap !important;
}

/* equal-wide-text-cols */
td[data-label="ë‚´ìš©"], td[data-label="ì°¸ê³ /ë©”ëª¨"], td[data-label="ë°˜ì„±/ì¹­ì°¬"],
th[data-label="ë‚´ìš©"], th[data-label="ì°¸ê³ /ë©”ëª¨"], th[data-label="ë°˜ì„±/ì¹­ì°¬"]{
  width: 33.333% !important;
}

/* keep-col-widths */
table{
  table-layout: fixed !important; /* ë‚´ìš©ì´ ê¸¸ì–´ì ¸ë„ ì—´ ë„ˆë¹„ ê³ ì • */
}
td[data-label="ë‚´ìš©"], td[data-label="ì°¸ê³ /ë©”ëª¨"], td[data-label="ë°˜ì„±/ì¹­ì°¬"]{
  overflow-wrap: anywhere;
  word-break: break-word; /* ê¸´ ë‹¨ì–´/URLë„ ì¹¸ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆ */
}
</style>
</head>
<body>
  <div class="wrap">
    
    <div class="ios-topbar">
      <div class="row1">
        <div class="ios-brand">
          <div class="ios-icon">ğŸ—’ï¸</div>
          <div class="ios-titlewrap">
            <h1 class="ios-title">ë¯¸ë‚˜ì˜ í•˜ë£¨ê¸°ë¡</h1>
            <div class="ios-sub">í•˜ë£¨ ë§ˆê°ìœ¼ë¡œ ì €ì¥í•˜ê³ , í‘œëŠ” ìƒˆë¡œ ì‹œì‘í•´ìš”</div>
          </div>
        </div>
        <div class="ios-chip" title="í˜„ì¬ ì‘ì—…ì¼">
          <span class="dot"></span>
          <span class="label" id="todayLabel">--</span>
        </div>
      </div>
    </div>
</div>
<div class="topbar">
      <div class="row">
        <div class="pill">í˜„ì¬ì‹œê°: <strong id="nowTxt">--:--</strong></div>
        <div class="pill">ë‹¤ìŒ ê¸°ë¡ ì‹œì‘(ìë™): <strong id="autoStartTxt">--:--</strong></div>
        <div class="pill">ì•Œë¦¼(ì •ì‹œ): <strong id="notifTxt">OFF</strong></div>
        <button id="btnEnableNotif">ì •ì‹œ ì•Œë¦¼ ì¼œê¸°</button>
        <button id="btnOpen">ì§€ê¸ˆ ê¸°ë¡í•˜ê¸°</button>
      </div>

      <!-- ìˆ˜ë™ ì‹œê°„ ì„¤ì •(ìš”ì²­ ê¸°ëŠ¥) -->
      <div class="card" style="margin-top:10px;">
        <div class="mini">
          <label><input type="checkbox" id="manualTimeToggle" /> ì‹œê°„ ì§ì ‘ ì„¤ì •</label>
          <div class="pill">ì‹œì‘: <strong id="manualStartTxt">ìë™</strong></div>
          <div class="pill">ì¢…ë£Œ: <strong id="manualEndTxt">ìë™</strong></div>
        </div>
        <div class="mini" id="manualTimeInputs" style="display:none; margin-top:10px;">
          <div>
            <label style="margin-bottom:6px;">ì‹œì‘ì‹œê°„</label>
            <input type="time" id="manualStart" />
          </div>
          <div>
            <label style="margin-bottom:6px;">ì¢…ë£Œì‹œê°„</label>
            <input type="time" id="manualEnd" />
          </div>
          <div class="hint">â€¢ ì €ì¥í•  ë•Œ ì´ ì‹œê°„ì´ ì ìš©ë¼ìš”. (ìì • ë„˜ê¹€ë„ ìë™ ì²˜ë¦¬)</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hint">
        ğŸ§¡ ë°”ë¡œí•´!  ğŸ§¡ ì¤‘ìš”ìˆœì„œ ê³„ì†ì •ë¦¬! ğŸ§¡ NOì¤‘ê°„ ìƒˆì¹˜ê¸°!<br/>
        âœ… ì‹œê°„ì€ ìë™ìœ¼ë¡œ ê¸°ë¡ë¼ìš”. (íœ´ëŒ€í°/PC ì‹œê³„ ê¸°ì¤€)<br/>
        âœ… ì €ì¥í•˜ë©´ <b>ì´ì „ ì¢…ë£Œ ì‹œê°„ â†’ ì§€ê¸ˆ</b> êµ¬ê°„ìœ¼ë¡œ ì €ì¥ë¼ìš”.<br/>
        âœ… íŒ¨ìŠ¤ëŠ” â€œê¸°ë¡í•  ë‚´ìš© ì—†ìŒâ€ìœ¼ë¡œ, <b>ì‹œê°„ë§Œ ê°±ì‹ </b>ë¼ìš”.<br/>
        âš ï¸ ë‹¨ì¼ HTML íŒŒì¼(file://) í™˜ê²½ì—ì„œëŠ” iOS ì•Œë¦¼ì´ ì œí•œë  ìˆ˜ ìˆì–´ìš”. (í‘œì‹œëŠ” ON/OFF í† ê¸€ ê¸°ì¤€)
      </div>
    </div>

    <table aria-label="ê¸°ë¡í‘œ">
      <thead>
        <tr>
          <th style="width:70px;">ì‹œì‘</th>
          <th style="width:70px;">ì¢…ë£Œ</th>
          <th>ë‚´ìš©</th>
          <th>ì°¸ê³ /ë©”ëª¨</th>
          <th>ë°˜ì„±/ì¹­ì°¬</th>
          <th style="width:70px;">ì†Œìš”</th>
          <th style="width:110px;">ì‘ì—…</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="btns">
      <button id="btnCopy">ğŸ“‹ ê²°ê³¼í‘œ ë³µì‚¬</button>
      <button id="btnCloseDay">í•˜ë£¨ ë§ˆê°(ì €ì¥/ë¦¬ì…‹)</button>
      <button id="btnCopyWeek">ì´ë²ˆì£¼ ê²°ê³¼í‘œ ë³µì‚¬</button>
      <button id="btnExport">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <button id="btnImport">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
      <button id="btnClear" class="danger">ì „ì²´ì‚­ì œ</button>
    </div>
    <div class="hint">
      â€¢ â€œê²°ê³¼í‘œ ë³µì‚¬â€ëŠ” ë…¸ì…˜/ë©”ëª¨/ì—‘ì…€ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸°(í‘œ) ê°€ëŠ¥í•´ìš”.<br/>
      â€¢ â€œë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°â€ëŠ” ë°±ì—…/ë³µêµ¬ìš©ì´ì—ìš”.
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-back" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
    <div class="sheet-scroll">

      <div class="row" style="justify-content:space-between;">
        <h2 id="modalTitle">ğŸ• ì§€ê¸ˆ ê¸°ë¡</h2>
        <button id="btnClose">ë‹«ê¸°</button>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <div class="pill">ì‹œì‘: <strong id="mStart">--:--</strong></div>
        <div class="pill">ì¢…ë£Œ: <strong id="mEnd">--:--</strong></div>
        <div class="pill">ì†Œìš”: <strong id="mDur">--</strong>
    </div>
</div>
      </div>

      <div class="mini" id="editTimeBox" style="display:none; margin-bottom:10px;">
        <div>
          <label style="margin-bottom:6px;">ì‹œì‘ì‹œê°„(ìˆ˜ì •)</label>
          <input type="time" id="editStart" />
        </div>
        <div>
          <label style="margin-bottom:6px;">ì¢…ë£Œì‹œê°„(ìˆ˜ì •)</label>
          <input type="time" id="editEnd" />
        </div>
        <div class="hint">â€¢ ìˆ˜ì • ì €ì¥ ì‹œ ì‹œì‘/ì¢…ë£Œ/ì†Œìš”ê°€ í•¨ê»˜ ì—…ë°ì´íŠ¸ë¼ìš”.</div>
      </div>


      
        <div class="tabs" id="tabBar">
          <button class="tabbtn active" data-tab="content">ë‚´ìš©</button>
          <button class="tabbtn" data-tab="memo">ì°¸ê³ /ë©”ëª¨</button>
          <button class="tabbtn" data-tab="reflect">ë°˜ì„±/ì¹­ì°¬</button>
        </div>

        <div class="tabpane active" id="pane-content" style="margin-top:10px;">
          <div class="card">
            <label>ë‚´ìš©</label>
            <textarea id="mContent" placeholder="ì˜ˆ) ì½”ë”©, ì„±ê²½í•„ì‚¬, ì¥ë³´ê¸° ..."></textarea>
          </div>
        </div>

        <div class="tabpane" id="pane-memo" style="margin-top:10px;">
          <div class="card">
            <label>ì°¸ê³  / ë©”ëª¨</label>
            <textarea id="mMemo" placeholder="ì˜ˆ) ë§í¬, ìƒí™© ì„¤ëª…, í•„ìš”í•œ ë©”ëª¨ ..."></textarea>
          </div>
        </div>

        <div class="tabpane" id="pane-reflect" style="margin-top:10px;">
          <div class="card">
            <label>ë°˜ì„± / ì¹­ì°¬</label>
            <textarea id="mReflect" placeholder="ì˜ˆ) ë°˜ì„±: í° ë°©í™© 10ë¶„ ë‚´ë¡œ / ì¹­ì°¬: ì§‘ì¤‘ ì˜í•¨"></textarea>
          </div>
        </div>


      <div class="btns">
        <button id="btnSave" class="primary">ì €ì¥</button>
        <button id="btnPass">íŒ¨ìŠ¤</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const K_LOGS = "mina_daylog_logs_v10";
  const K_LAST = "mina_daylog_last_end_v10";
  const K_NOTIF_ENABLED = "mina_daylog_notif_enabled_v10";

  const ARCHIVE_KEY = "mina_daylog_archive_v10";
  const ACTIVE_DATE_KEY = "mina_daylog_active_date_v10";

  let logs = [];
  let lastEnd = null; // Date
  let notifEnabled = (localStorage.getItem(K_NOTIF_ENABLED) === "1");
  let editId = null;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(d){ return pad2(d.getHours()) + ":" + pad2(d.getMinutes()); }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

  function durationText(ms){
    const m = Math.max(1, Math.round(ms/60000)); // ìµœì†Œ 1ë¶„
    const h = Math.floor(m/60);
    const mm = m%60;
    if(h===0) return mm + "ë¶„";
    if(mm===0) return h + "ì‹œê°„";
    return h + "ì‹œê°„ " + mm + "ë¶„";
  }

  function parseLast(){
    const s = localStorage.getItem(K_LAST);
    if(!s) return null;
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }
  function saveLast(d){
    lastEnd = d;
    localStorage.setItem(K_LAST, d.toISOString());
    updateHeaderTimes();
  }

  function escapeHtml(s){
    return (s??"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function nl2br(s){ return s.replace(/\n/g,"<br/>"); }

  
  // ì‹œê°„ìˆœ ì •ë ¬: ì‹œì‘ì‹œê°„ ê¸°ì¤€(ì…ë ¥ ìˆœì„œê°€ ë’¤ì£½ë°•ì£½ì´ì–´ë„ í‘œëŠ” ì‹œê°„ìˆœ)
  function timeToMin(t){
    if(!t || !/^\d{2}:\d{2}$/.test(t)) return null;
    const [hh, mm] = t.split(":").map(Number);
    return hh*60 + mm;
  }
  function sortLogsInPlace(arr){
    if(!Array.isArray(arr) || arr.length <= 1) return arr;

    const mins = arr.map(x=>timeToMin(x.start)).filter(v=>v!==null);
    const hasLate = mins.some(v=>v>=18*60);
    const hasEarly = mins.some(v=>v<=6*60);
    const bumpEarly = hasLate && hasEarly;

    const indexed = arr.map((x,i)=>({x,i}));
    indexed.sort((a,b)=>{
      let ma = timeToMin(a.x.start);
      let mb = timeToMin(b.x.start);
      ma = (ma===null) ? 1e9 : (bumpEarly && ma<=6*60 ? ma+24*60 : ma);
      mb = (mb===null) ? 1e9 : (bumpEarly && mb<=6*60 ? mb+24*60 : mb);
      if(ma!==mb) return ma-mb;
      return a.i-b.i;
    });
    for(let i=0;i<indexed.length;i++) arr[i] = indexed[i].x;
    return arr;
  }
function persist(){
    sortLogsInPlace(logs); localStorage.setItem(K_LOGS, JSON.stringify(logs)); }

  function notifStatus(){
    const supported = ("Notification" in window);
    const perm = supported ? Notification.permission : "unsupported";
    return { supported, perm };
  }
  function setNotifPill(){
    const on = notifEnabled === true;
    $("notifTxt").textContent = on ? "ON" : "OFF";
    $("btnEnableNotif").textContent = on ? "ì •ì‹œ ì•Œë¦¼ ë„ê¸°" : "ì •ì‹œ ì•Œë¦¼ ì¼œê¸°";
    const st = notifStatus();
    let tip = "";
    if(!st.supported) tip = "ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.";
    else tip = "ê¶Œí•œ: " + st.perm + " (í‘œì‹œëŠ” í† ê¸€ ON/OFF ê¸°ì¤€)";
    $("notifTxt").title = tip;
  }

  async function toggleNotif(){
    // í† ê¸€ì€ ë¬´ì¡°ê±´ ì‘ë™(í‘œì‹œ ê¸°ì¤€)
    notifEnabled = !notifEnabled;
    localStorage.setItem(K_NOTIF_ENABLED, notifEnabled ? "1" : "0");
    setNotifPill();

    // ì¼¤ ë•Œë§Œ ê¶Œí•œ ìš”ì²­(ê°€ëŠ¥í•œ ê²½ìš°). ì‹¤íŒ¨í•´ë„ í† ê¸€ í‘œì‹œ ìœ ì§€.
    if(notifEnabled){
      const st = notifStatus();
      if(st.supported){
        try{
          const perm = await Notification.requestPermission();
          // title ê°±ì‹ 
          setNotifPill();
          if(perm !== "granted"){
            alert("ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ì–´ìš”. (ì„¤ì •ì—ì„œ ì•Œë¦¼ í—ˆìš© í•„ìš”)");
          }
        }catch(e){
          // ì¡°ìš©íˆ ë¬´ì‹œ
          setNotifPill();
        }
      }
    }
  }

  // ìˆ˜ë™ ì‹œê°„ ì„¤ì • (ìš”ì²­ ê¸°ëŠ¥)
  function manualEnabled(){ return $("manualTimeToggle").checked; }

  function setManualUI(){
    const on = manualEnabled();
    $("manualTimeInputs").style.display = on ? "flex" : "none";
    $("manualStartTxt").textContent = on ? ($("manualStart").value || "--:--") : "ìë™";
    $("manualEndTxt").textContent = on ? ($("manualEnd").value || "--:--") : "ìë™";
  }

  function baseDateFromISO(iso){
    const d = new Date(iso);
    return isNaN(d.getTime()) ? new Date() : d;
  }

  function hhmmFromText(t){
    // expects 'HH:MM'
    if(!t) return "";
    const m = String(t).match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return "";
    return String(m[1]).padStart(2,'0') + ':' + m[2];
  }

  function dateWithTime(baseDate, hhmm){
    const [hh, mm] = hhmm.split(":").map(Number);
    const d = new Date(baseDate);
    d.setHours(hh, mm, 0, 0);
    return d;
  }

  // ìë™ ì‹œì‘ì‹œê°„: ë‚ ì§œê°€ ë°”ë€Œì—ˆê³  ë¹„ì •ìƒì ìœ¼ë¡œ ì»¤ì§€ë©´(18h ì´ˆê³¼) ê°™ì€ ë‚ ì§œì˜ ì‹œê°„ìœ¼ë¡œ ë³´ì •
  function autoStartFor(end){
    if(!lastEnd) return end;
    const s = new Date(lastEnd);
    if(isNaN(s.getTime())) return end;
    if(sameDay(s,end)) return s;
    const diff = end - s;
    if(diff > 18*60*60*1000){
      const adj = new Date(end);
      adj.setHours(s.getHours(), s.getMinutes(), 0, 0);
      if(adj > end) adj.setDate(adj.getDate()-1);
      return adj;
    }
    return s;
  }

  function computeTimesPreview(){
    const endAuto = new Date();
    let start = autoStartFor(endAuto);
    let end = endAuto;

    if(manualEnabled()){
      const ms = $("manualStart").value;
      const me = $("manualEnd").value;
      if(ms && me){
        // ê¸°ì¤€ ë‚ ì§œëŠ” "ì˜¤ëŠ˜"ë¡œ
        start = dateWithTime(endAuto, ms);
        end = dateWithTime(endAuto, me);
        // ìì • ë„˜ê¹€ ì²˜ë¦¬
        if(end < start) end.setDate(end.getDate()+1);
      }
    }
    $("mStart").textContent = fmtTime(start);
    $("mEnd").textContent = fmtTime(end);
    $("mDur").textContent = durationText(end - start);
    return { start, end };
  }

  function updateHeaderTimes(){
    $("nowTxt").textContent = fmtTime(new Date());
    $("autoStartTxt").textContent = lastEnd ? fmtTime(autoStartFor(new Date())) : "--:--";
    setManualUI();
  }

  function openModal(){
    editId = null;
    $("editTimeBox").style.display = "none";
    $("btnSave").textContent = "ì €ì¥";
    $("modalTitle").textContent = "ğŸ• ì§€ê¸ˆ ê¸°ë¡";
    computeTimesPreview();
    $("modalBack").style.display = "flex"; document.body.classList.add("modal-open");
    if(window.setActiveTab){ window.setActiveTab("content"); } else { setTimeout(()=> $("mContent").focus(), 50); }
  }
  function closeModal(){
    $("modalBack").style.display = "none"; document.body.classList.remove("modal-open");
    $("editTimeBox").style.display = "none";
    $("mContent").value = "";
    $("mMemo").value = "";
    $("mReflect").value = "";
    editId = null;
    $("btnSave").textContent = "ì €ì¥";
    $("modalTitle").textContent = "ğŸ• ì§€ê¸ˆ ê¸°ë¡";
  }

  function addLogFromModal(){
    const { start, end } = computeTimesPreview();
    const row = {
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random()),
      startISO: start.toISOString(),
      endISO: end.toISOString(),
      start: fmtTime(start),
      end: fmtTime(end),
      content: $("mContent").value || "",
      memo: $("mMemo").value || "",
      reflect: $("mReflect").value || "",
      dur: durationText(end - start)
    };
    logs.push(row);
    persist();
    saveLast(end);
    render();
  }

  function doPass(){
    // íŒ¨ìŠ¤ë„ ìˆ˜ë™ ì‹œê°„ì´ ì¼œì ¸ ìˆê³  ì¢…ë£Œì‹œê°„ì´ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ ê¸°ì¤€ì‹œê°„ ê°±ì‹ 
    if(manualEnabled() && $("manualEnd").value){
      const end = dateWithTime(new Date(), $("manualEnd").value);
      saveLast(end);
    }else{
      saveLast(new Date());
    }
    render();
  }

  function delRow(id){
    logs = logs.filter(x=>x.id!==id);
    persist();
    render();
  }

  function startEdit(id){
    const row = logs.find(x=>x.id===id);
    if(!row){ alert("ìˆ˜ì •í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”."); return; }
    editId = id;
    $("modalTitle").textContent = "âœï¸ ê¸°ë¡ ìˆ˜ì •";
    $("btnSave").textContent = "ìˆ˜ì • ì €ì¥";
    $("mContent").value = row.content || "";
    $("mMemo").value = row.memo || "";
    $("mReflect").value = row.reflect || "";
    $("mStart").textContent = row.start || "--:--";
    $("mEnd").textContent = row.end || "--:--";
    $("mDur").textContent = row.dur || "--";
    // ì‹œì‘/ì¢…ë£Œ ì‹œê°„ë„ ìˆ˜ì • ê°€ëŠ¥
    $("editTimeBox").style.display = "flex";
    $("editStart").value = hhmmFromText(row.start);
    $("editEnd").value = hhmmFromText(row.end);
    $("modalBack").style.display = "flex"; document.body.classList.add("modal-open");
    if(window.setActiveTab){ window.setActiveTab("content"); } else { setTimeout(()=> $("mContent").focus(), 50); }
  }

    function commitEdit(){
    const idx = logs.findIndex(x=>x.id===editId);
    if(idx < 0){ alert("ìˆ˜ì •í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”."); return; }
    const row = logs[idx];
    row.content = $("mContent").value;
    row.memo = $("mMemo").value;
    row.reflect = $("mReflect").value;

    // ì‹œê°„ ìˆ˜ì •(ì„ íƒ): ì…ë ¥ì´ ìˆìœ¼ë©´ ì‹œì‘/ì¢…ë£Œ/ì†Œìš”ê¹Œì§€ ì—…ë°ì´íŠ¸
    const es = $("editStart").value;
    const ee = $("editEnd").value;
    if(es && ee){
      const base = baseDateFromISO(row.startISO || row.endISO || new Date().toISOString());
      let start = dateWithTime(base, es);
      let end = dateWithTime(base, ee);
      if(end < start) end.setDate(end.getDate()+1); // ìì • ë„˜ê¹€
      row.startISO = start.toISOString();
      row.endISO = end.toISOString();
      row.start = fmtTime(start);
      row.end = fmtTime(end);
      row.dur = durationText(end - start);
      // ë§ˆì§€ë§‰ ê¸°ë¡ì„ ìˆ˜ì •í–ˆë‹¤ë©´ ë‹¤ìŒ ìë™ ì‹œì‘ ê¸°ì¤€ë„ ë§ì¶°ì¤€ë‹¤
      if(idx === logs.length - 1){
        saveLast(end);
      }
    }

    persist();
    render();
    closeModal();
  }

  function render(){
    sortLogsInPlace(logs);
    const tb = $("tbody");
    if(!logs.length){
      tb.innerHTML = `<tr><td colspan="7" class="hint">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. â€œì§€ê¸ˆ ê¸°ë¡í•˜ê¸°â€ë¡œ ì‹œì‘í•´ë´ìš”.</td></tr>`;
      return;
    }
    tb.innerHTML = logs.map(r=>`
      <tr>
        <td data-label="ì‹œì‘">${escapeHtml(r.start)}</td>
        <td data-label="ì¢…ë£Œ">${escapeHtml(r.end)}</td>
        <td data-label="ë‚´ìš©">${nl2br(escapeHtml(r.content))}</td>
        <td data-label="ì°¸ê³ /ë©”ëª¨">${nl2br(escapeHtml(r.memo))}</td>
        <td data-label="ë°˜ì„±/ì¹­ì°¬">${nl2br(escapeHtml(r.reflect))}</td>
        <td data-label="ì†Œìš”">${escapeHtml(r.dur)}</td>
        <td class="right" data-label="ì‘ì—…">
          <button data-edit="${r.id}">ìˆ˜ì •</button>
          <button data-del="${r.id}">ì‚­ì œ</button>
        </td>
      </tr>
    `).join("");

    tb.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        if(confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) delRow(id);
      });
    });
    tb.querySelectorAll("button[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-edit");
        startEdit(id);
      });
    });
  }

    async function copyTableForNotion(){
    if(!logs.length){ alert("ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ì–´ìš”."); return; }
    // ë…¸ì…˜ì— ë¶™ì—¬ë„£ê¸° ìµœì : â‘  HTML table â‘¡ TSV(plain) ë‘˜ ë‹¤ í´ë¦½ë³´ë“œì— ë„£ê¸°
    const headers = ["ì‹œì‘","ì¢…ë£Œ","ë‚´ìš©","ì°¸ê³  / ë©”ëª¨","ë°˜ì„± ë° ì¹­ì°¬","ì†Œìš”"];

    const cellPlain = (v)=> String(v||"")
      .replace(/\t/g," ")
      .replace(/\r?\n/g," ");
    const cellHtml = (v)=> escapeHtml(String(v||"")).replace(/\r?\n/g,"<br/>");

    // TSV (plain)
    let tsv = headers.join("\t") + "\n";
    logs.forEach(x=>{
      tsv += [x.start, x.end, cellPlain(x.content), cellPlain(x.memo), cellPlain(x.reflect), cellPlain(x.dur)].join("\t") + "\n";
    });

    // HTML table
    let htmlTable = "<table><thead><tr>" + headers.map(h=>"<th>"+h+"</th>").join("") + "</tr></thead><tbody>";
    logs.forEach(x=>{
      htmlTable += "<tr>" +
        "<td>"+escapeHtml(x.start||"")+"</td>" +
        "<td>"+escapeHtml(x.end||"")+"</td>" +
        "<td>"+cellHtml(x.content)+"</td>" +
        "<td>"+cellHtml(x.memo)+"</td>" +
        "<td>"+cellHtml(x.reflect)+"</td>" +
        "<td>"+escapeHtml(x.dur||"")+"</td>" +
      "</tr>";
    });
    htmlTable += "</tbody></table>";

    try{
      if(navigator.clipboard && window.ClipboardItem){
        const item = new ClipboardItem({
          "text/plain": new Blob([tsv], {type:"text/plain"}),
          "text/html": new Blob([htmlTable], {type:"text/html"})
        });
        await navigator.clipboard.write([item]);
      }else{
        await navigator.clipboard.writeText(tsv);
      }
      alert("ë…¸ì…˜ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥! (ê²°ê³¼í‘œ ë³µì‚¬ ì™„ë£Œ)");
    }catch(e){
      // iOS ë“±ì—ì„œ ê¶Œí•œ/ì§€ì› ë¬¸ì œ ì‹œ fallback
      try{ await navigator.clipboard.writeText(tsv); alert("ë…¸ì…˜ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥! (í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬ ì™„ë£Œ)"); }
      catch(_){ prompt("ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ë…¸ì…˜ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”:", tsv); }
    }
  }

  async function exportJSON(){
    const data = { version: 10, exportedAt: new Date().toISOString(), lastEndISO: lastEnd ? lastEnd.toISOString() : null, logs };
    const text = JSON.stringify(data, null, 2);
    try{
      await navigator.clipboard.writeText(text);
      alert("ë°±ì—… JSONì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”. ë…¸ì…˜/ë©”ëª¨ì— ë¶™ì—¬ë„£ì–´ ì €ì¥í•´ë‘ì„¸ìš”.");
    }catch(e){
      prompt("ì•„ë˜ JSONì„ ë³µì‚¬í•´ì„œ ì €ì¥í•´ë‘ì„¸ìš”:", text);
    }
  }

  function importJSON(){
    const raw = prompt("ë°±ì—… JSONì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:");
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if(!data || !Array.isArray(data.logs)) throw new Error("í˜•ì‹ ì˜¤ë¥˜");
      logs = data.logs;
      persist();
      const le = data.lastEndISO ? new Date(data.lastEndISO) : null;
      if(le && !isNaN(le.getTime())) saveLast(le);
      render();
      alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
    }catch(e){
      alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ì„ í™•ì¸í•´ì¤˜ìš”.");
    }
  }

  function clearAll(){
    if(!confirm("ì „ì²´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”)")) return;
    logs = [];
    persist();
    saveLast(new Date());
    render();
  }

  function load(){
    /* ko-input-hints */
    try{
      document.documentElement.lang = "ko";
      ["mContent","mMemo","mReflect"].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.setAttribute("lang","ko");
        el.setAttribute("inputmode","text");
        el.setAttribute("autocapitalize","none");
        el.setAttribute("autocomplete","off");
        el.setAttribute("spellcheck","false");
      });
    }catch(_){}

    try{ logs = JSON.parse(localStorage.getItem(K_LOGS) || "[]") || []; }catch(e){ logs = []; }
    // ë‚ ì§œê°€ ë°”ë€Œì—ˆê³  í˜„ì¬ ê¸°ë¡ì´ ë¹„ì–´ ìˆìœ¼ë©´, ìë™ìœ¼ë¡œ 'ì˜¤ëŠ˜' ì‘ì—…ì¼ë¡œ ë§ì¶°ìš”.
    try{ const today = yyyyMmDd(new Date()); const active = getActiveDate(); if(active !== today && (!logs || !logs.length)) setActiveDate(today); }catch(_){ }
    lastEnd = parseLast();
    if(!lastEnd) saveLast(new Date());
    render();
    updateTodayLabel();
    updateHeaderTimes();
    setNotifPill();
  }

  // ì •ì‹œ ì•Œë¦¼/íŒì—… (í˜ì´ì§€ ì—´ë ¤ ìˆì„ ë•Œ)
  let lastHourFired = null;
  function tick(){
    updateHeaderTimes();
    const d = new Date();
    if(d.getMinutes()===0){
      const key = d.getFullYear()+"-"+d.getMonth()+"-"+d.getDate()+"-"+d.getHours();
      if(lastHourFired !== key){
        lastHourFired = key;
        if(notifEnabled && ("Notification" in window) && Notification.permission==="granted"){
          try{ new Notification("í•˜ë£¨ê¸°ë¡", { body: "ì •ì‹œ ê¸°ë¡í•  ì‹œê°„ì´ì—ìš”." }); }catch(e){}
        }
        openModal();
      }
    }
  }

  // Wire (ë²„íŠ¼ ì‘ë™ í™•ì‹¤)
  $("btnOpen").addEventListener("click", openModal);

  function setActiveTab(name){
    const bar = $("tabBar");
    if(!bar) return;
    bar.querySelectorAll(".tabbtn").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-tab")===name);
    });
    ["content","memo","reflect"].forEach(n=>{
      const pane = $("pane-"+n);
      if(pane) pane.classList.toggle("active", n===name);
    });
    // focus the active textarea
    const focusId = (name==="content") ? "mContent" : (name==="memo" ? "mMemo" : "mReflect");
    const el = $(focusId);
    if(el) setTimeout(()=>el.focus(), 50);
  }

  function wireTabs(){
    const bar = $("tabBar");
    if(!bar) return;
    bar.addEventListener("click", (e)=>{
      const btn = e.target.closest(".tabbtn");
      if(!btn) return;
      setActiveTab(btn.getAttribute("data-tab"));
    });
  }

  wireTabs();
  $("btnClose").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeModal(); });

  $("btnSave").addEventListener("click", ()=>{
    if(editId){ commitEdit(); return; }
    addLogFromModal();
    closeModal();
  });
  $("btnPass").addEventListener("click", ()=>{ doPass(); closeModal(); });

  function yyyyMm(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; }
  function yyyyMmDd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  function weekdayKo(d){
    return ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
  }

  function loadArchive(){
    try{ return JSON.parse(localStorage.getItem(ARCHIVE_KEY) || "{}") || {}; }catch(_){ return {}; }
  }
  function saveArchive(obj){
    localStorage.setItem(ARCHIVE_KEY, JSON.stringify(obj));
  }

  
  // ---- Archive backward compatibility helpers ----
  function getDayLogs(dayObj){
    if(!dayObj) return [];
    const arr = dayObj.logs || dayObj.items || dayObj.records || dayObj.rows || dayObj.entries || [];
    return Array.isArray(arr) ? arr : [];
  }
  function setDayLogs(dayObj, logsArr){
    dayObj.logs = Array.isArray(logsArr) ? logsArr : [];
    delete dayObj.items; delete dayObj.records; delete dayObj.rows; delete dayObj.entries;
    return dayObj;
  }

function getActiveDate(){
    const saved = localStorage.getItem(ACTIVE_DATE_KEY);
    if(saved && /^\d{4}-\d{2}-\d{2}$/.test(saved)) return saved;
    const today = yyyyMmDd(new Date());
    localStorage.setItem(ACTIVE_DATE_KEY, today);
    return today;
  }
  function setActiveDate(ymd){
    localStorage.setItem(ACTIVE_DATE_KEY, ymd);
    updateTodayLabel();
  }

  function updateTodayLabel(){
    // âœ… ìƒë‹¨ ë‚ ì§œëŠ” í˜„ì¬ ê¸°ê¸°/PCì˜ 'ì˜¤ëŠ˜' ë‚ ì§œ(ìš”ì¼) ê¸°ì¤€
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    const d = String(now.getDate()).padStart(2,"0");
    const label = `${y}-${m}-${d} (${weekdayKo(now)})`;
    const el = $("todayLabel");
    if(el) el.textContent = label;
  }

  function closeDay(){
    const activeYmd = getActiveDate();
    const todayYmd = yyyyMmDd(new Date());

    if(!logs.length){
      // ê¸°ë¡ì´ ì—†ì–´ë„ í‘œë§Œ ë¦¬ì…‹(ì €ì¥ ì—†ìŒ)
      if(confirm("ì˜¤ëŠ˜ ê¸°ë¡ì´ ë¹„ì–´ ìˆì–´ìš”. ê·¸ë˜ë„ 'í•˜ë£¨ ë§ˆê°'í•˜ê³  í‘œë¥¼ ë¦¬ì…‹í• ê¹Œìš”?")){
        logs = [];
        persist();
        saveLast(new Date());
        render();
        // ê³¼ê±° ë‚ ì§œë¥¼ ë³´ê³  ìˆì—ˆë‹¤ë©´ 'ì˜¤ëŠ˜'ë¡œ ë˜ëŒë¦¼
        if(activeYmd !== todayYmd) setActiveDate(todayYmd);
      }
      return;
    }

    const d = new Date(activeYmd+"T00:00:00");
    const yymm = yyyyMm(d);
    const archive = loadArchive();
    archive[yymm] = archive[yymm] || { month: yymm, days: [] };

    // âœ… ê°™ì€ ë‚ ì§œì— 'í•˜ë£¨ ë§ˆê°'ì„ ì—¬ëŸ¬ ë²ˆ ëˆŒëŸ¬ë„: ìƒˆ ë‚ ì§œë¡œ ë§Œë“¤ì§€ ì•Šê³  ê°™ì€ ë‚ ì§œì— "ëˆ„ì  ì €ì¥"
    const newLogs = JSON.parse(JSON.stringify(logs || []));
    const idx = archive[yymm].days.findIndex(x=>x.date===activeYmd);

    if(idx>=0){
      const existing = archive[yymm].days[idx] || { date: activeYmd, weekday: weekdayKo(d), logs: [] };
      existing.weekday = weekdayKo(d);
      existing.logs = getDayLogs(existing).concat(newLogs);
      setDayLogs(existing, existing.logs);

      // ì‹œê°„ìˆœ ì •ë ¬(ì‹œì‘ â†’ ì¢…ë£Œ)
      existing.logs.sort((a,b)=> (String(a.start||"")).localeCompare(String(b.start||"")) || (String(a.end||"")).localeCompare(String(b.end||"")));
      archive[yymm].days[idx] = existing;
    }else{
      archive[yymm].days.push(setDayLogs({ date: activeYmd, weekday: weekdayKo(d) }, newLogs));
    }

    // ë‚ ì§œìˆœ ì •ë ¬
    archive[yymm].days.sort((a,b)=> a.date.localeCompare(b.date));
    saveArchive(archive);

    // UI ë¦¬ì…‹: logs ë¹„ìš°ê³  lastEndë„ "ì§€ê¸ˆ"ìœ¼ë¡œ
    logs = [];
    persist();
    saveLast(new Date());
    render();

    // ê°™ì€ ë‚ ì§œì—ì„œ ë§ˆê°ì„ ì—¬ëŸ¬ ë²ˆ ëˆŒëŸ¬ë„ ë‚ ì§œëŠ” ìœ ì§€.
    // ê³¼ê±° ë‚ ì§œë¥¼ ë§ˆê°í•œ ê²½ìš°ì—” 'ì˜¤ëŠ˜'ë¡œ ëŒì•„ê°.
    if(activeYmd !== todayYmd) setActiveDate(todayYmd);

    alert(`í•˜ë£¨ ë§ˆê° ì™„ë£Œ! (${activeYmd})
ì´ë²ˆì£¼ ê²°ê³¼í‘œ ë³µì‚¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`);
  }

  function advanceActiveDateBy1(){
    const activeYmd = getActiveDate();
    const base = new Date(activeYmd+"T00:00:00");
    base.setDate(base.getDate()+1);
    setActiveDate(yyyyMmDd(base));
  }

  // ìì •ì´ ì§€ë‚˜ 'ì˜¤ëŠ˜'ì´ ë°”ë€Œì–´ë„ ìë™ ë¦¬ì…‹ì€ í•˜ì§€ ì•ŠìŒ.
  // ëŒ€ì‹  activeDateê°€ ì˜¤ëŠ˜ë³´ë‹¤ ê³¼ê±°ì¸ë° ê¸°ë¡ì´ ë‚¨ì•„ ìˆìœ¼ë©´, ì‚¬ìš©ìê°€ ì›í•  ë•Œ 'í•˜ë£¨ ë§ˆê°'í•˜ë©´ ë¼ìš”.
  
  async function copyWeekTable(){
    try{
      const active = getActiveDate();
      const base = new Date(active+"T00:00:00");
      const day = base.getDay();
      const diffToMon = (day === 0) ? -6 : (1 - day);
      const mon = new Date(base); mon.setDate(base.getDate() + diffToMon);
      const sun = new Date(mon); sun.setDate(mon.getDate() + 6);

      const startYmd = yyyyMmDd(mon);
      const endYmd = yyyyMmDd(sun);

      const archive = loadArchive();
      const days = [];
      Object.keys(archive).forEach(mm=>{
        const block = archive[mm];
        (block?.days || []).forEach(d=>{
          if(d.date >= startYmd && d.date <= endYmd){
            setDayLogs(d, getDayLogs(d));
            days.push(d);
          }
        });
      });
      days.sort((a,b)=> a.date.localeCompare(b.date));

      if(!days.length){
        alert("ì´ë²ˆì£¼ì— ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”. ë¨¼ì € 'í•˜ë£¨ ë§ˆê°'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        return;
      }

      const headers = ["ì‹œì‘","ì¢…ë£Œ","ë‚´ìš©","ì°¸ê³ /ë©”ëª¨","ë°˜ì„±/ì¹­ì°¬","ì†Œìš”"];
      const esc = (s)=> String(s||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");

      // âœ… Notion í‘œ í˜•íƒœë¡œ ë¶™ë„ë¡: text/html(í…Œì´ë¸”) + text/plain(ë°±ì—…) ë™ì‹œì— í´ë¦½ë³´ë“œì— ë„£ê¸°
      let html = `<div>`;
      days.forEach(d=>{
        const label = `${d.date} (${d.weekday})`;
        html += `<div style="margin:10px 0 6px;font-weight:700;">${esc(label)}</div>`;
        html += `<table style="border-collapse:collapse;width:100%;max-width:100%;">`;
        html += `<thead><tr>` + headers.map(h=>`<th style="border:1px solid #ddd;padding:6px 8px;background:#f6f7f9;text-align:left;">${esc(h)}</th>`).join("") + `</tr></thead>`;
        html += `<tbody>`;
        (getDayLogs(d)||[]).forEach(x=>{
          html += `<tr>` +
            `<td style="border:1px solid #ddd;padding:6px 8px;">${esc(x.start)}</td>` +
            `<td style="border:1px solid #ddd;padding:6px 8px;">${esc(x.end)}</td>` +
            `<td style="border:1px solid #ddd;padding:6px 8px;">${esc(x.content)}</td>` +
            `<td style="border:1px solid #ddd;padding:6px 8px;">${esc(x.memo)}</td>` +
            `<td style="border:1px solid #ddd;padding:6px 8px;">${esc(x.reflect)}</td>` +
            `<td style="border:1px solid #ddd;padding:6px 8px;">${esc(x.dur)}</td>` +
          `</tr>`;
        });
        html += `</tbody></table>`;
      });
      html += `</div>`;

      const cell = (v)=>{
        const s = String(v||"");
        return s.split("\t").join(" ").split("\n").join(" ").split("\r").join(" ");
      };
      let plain = "";
      days.forEach(d=>{
        plain += `${d.date} (${d.weekday})\n`;
        plain += headers.join("\t") + "\n";
        (getDayLogs(d)||[]).forEach(x=>{
          plain += [cell(x.start),cell(x.end),cell(x.content),cell(x.memo),cell(x.reflect),cell(x.dur)].join("\t") + "\n";
        });
        plain += "\n";
      });

      let copied = false;

      // Clipboard API (ê°€ëŠ¥í•˜ë©´ HTML í…Œì´ë¸”ë¡œ ë³µì‚¬)
      if(navigator.clipboard && navigator.clipboard.write && window.ClipboardItem){
        try{
          const item = new ClipboardItem({
            "text/html": new Blob([html], {type:"text/html"}),
            "text/plain": new Blob([plain], {type:"text/plain"})
          });
          await navigator.clipboard.write([item]);
          copied = true;
        }catch(e){
          copied = false;
        }
      }

      // Fallback: execCommand (plain text)
      if(!copied){
        const ta = document.createElement("textarea");
        ta.value = plain.trim() + "\n";
        ta.setAttribute("readonly","");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        ta.setSelectionRange(0, ta.value.length);
        try{ copied = document.execCommand("copy"); }catch(_){ copied = false; }
        document.body.removeChild(ta);
      }

      if(copied){
        alert(`ì´ë²ˆì£¼(${startYmd}~${endYmd}) ê²°ê³¼í‘œ ë³µì‚¬ ì™„ë£Œ! ë…¸ì…˜ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.`);
      }else{
        prompt("ìë™ ë³µì‚¬ê°€ ë§‰í˜”ì–´ìš”. ì•„ë˜ ë‚´ìš©ì„ ì§ì ‘ ë³µì‚¬í•´ì„œ ë…¸ì…˜ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”:", plain);
      }
    }catch(err){
      alert("ì´ë²ˆì£¼ ê²°ê³¼í‘œ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: " + (err && err.message ? err.message : err));
    }
  }






  function maybePromptNewDay(){
    const active = getActiveDate();
    const today = yyyyMmDd(new Date());
    if(active !== today && logs.length){
      // ì¡°ìš©íˆ í‘œì‹œë§Œ (ìë™ íŒì—… ê¸ˆì§€)
      // ì‚¬ìš©ìê°€ 'í•˜ë£¨ ë§ˆê°'ì„ ëˆ„ë¥´ë©´ ì €ì¥/ë¦¬ì…‹ë¨.
    }
  }



  $("btnCopy").addEventListener("click", copyTableForNotion);
  const bcd = $("btnCloseDay"); if(bcd) bcd.addEventListener("click", closeDay);
  const bcw = $("btnCopyWeek"); if(bcw) bcw.addEventListener("click", copyWeekTable);
  $("btnExport").addEventListener("click", exportJSON);
  $("btnImport").addEventListener("click", importJSON);
  $("btnClear").addEventListener("click", clearAll);

  $("btnEnableNotif").addEventListener("click", toggleNotif);

  $("manualTimeToggle").addEventListener("change", ()=>{ setManualUI(); computeTimesPreview(); });
  $("manualStart").addEventListener("change", ()=>{ setManualUI(); computeTimesPreview(); });
  $("manualEnd").addEventListener("change", ()=>{ setManualUI(); computeTimesPreview(); });

  // Start
  load();
  document.addEventListener("visibilitychange", ()=>{ setNotifPill(); updateHeaderTimes(); });
  setInterval(tick, 1000);
})();
</script>
</body>
</html>
