<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>í•˜ë£¨ê¸°ë¡ (iPhone ì™„ì „ì•ˆì • v10)</title>
  <style>
    :root { --b:#e5e7eb; --bg:#ffffff; --muted:#6b7280; --card:#f9fafb; --ink:#111827; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
           background:var(--bg); color:var(--ink); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .topbar{
      position: sticky; top: 0; z-index: 20;
      background: rgba(255,255,255,0.98);
      backdrop-filter: saturate(180%) blur(10px);
      border-bottom: 1px solid var(--b);
      padding: 10px 0;
      margin: -16px -16px 12px;
      padding-left: 16px; padding-right: 16px;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { font-size: 13px; padding: 10px 12px; border:1px solid var(--b); border-radius:999px; background:#fff; }
    .pill strong { font-weight:800; }
    button { border:1px solid var(--b); background:#fff; border-radius:12px; padding:10px 12px; font-size:14px; cursor:pointer; min-height:44px; }
    button.primary{ background:var(--ink); color:#fff; border-color:var(--ink); }
    button.danger{ background:#fff; color:#b91c1c; border-color:#fecaca; }
    .card { border:1px solid var(--b); border-radius:14px; background:var(--card); padding:12px; }
    .hint { font-size:12px; color:var(--muted); line-height:1.5; margin-top:6px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 4px; }
    table { width:100%; border-collapse:collapse; margin-top:14px; font-size:13px; }
    th, td { border:1px solid var(--b); padding:8px; vertical-align:top; }
    th { background:#f3f4f6; text-align:left; }
    td { background:#fff; }
    .right { text-align:right; }

    /* Modal */
    .modal-back { position:fixed; inset:0; background:rgba(17,24,39,.48); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal { width:min(860px, 100%); background:#fff; border-radius:16px; border:1px solid var(--b); padding:14px; }
    .modal h2 { font-size:16px; margin:0 0 8px; }
    .grid { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 860px){ .grid{ grid-template-columns: 1fr 1fr 1fr; } }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    textarea { width:100%; height: 110px; resize: vertical; border:1px solid var(--b); border-radius:12px; padding:10px; font-size:14px; background:#fff; outline:none; }
    textarea:focus{ box-shadow: 0 0 0 3px rgba(59,130,246,.15); border-color:#93c5fd; }
    .mini { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .mini input[type="time"]{ border:1px solid var(--b); border-radius:12px; padding:10px; min-height:44px; font-size:14px; }
    .mini label{ margin:0; font-size:13px; color:var(--ink); }

    /* Mobile: stacked label/value per row */
    @media (max-width: 640px){
      .pill{ width:100%; }
      .row button{ width:100%; }
      .btns button{ width:100%; }
      table thead{ display:none; }
      table, tbody, tr{ display:block; width:100%; }
      tr{ margin:10px 0; border:1px solid var(--b); border-radius:12px; overflow:hidden; }
      td{
        display:flex;
        gap:10px;
        border:none;
        border-bottom:1px solid var(--b);
        padding:10px;
      }
      td:last-child{ border-bottom:none; }
      td::before{
        content: attr(data-label);
        flex:0 0 92px;
        font-size:12px;
        color:var(--muted);
        font-weight:800;
      }
      .right{ text-align:left; }
    }
  
    /* Mobile modal usability (iPhone Safari) */
    .modal-back{ -webkit-overflow-scrolling: touch; }
    .modal{ max-height: calc(100vh - 24px); overflow:auto; }
    @media (max-width: 640px){
      .modal-back{ align-items:flex-start; justify-content:center; padding: 12px; padding-top: calc(12px + env(safe-area-inset-top)); }
      .modal{ width: 100%; border-radius: 14px; max-height: calc(100vh - 24px - env(safe-area-inset-top)); }
      textarea{ height: 120px; }
      .grid{ gap: 10px; }
      /* Make modal header sticky so close/save always reachable */
      .modal .row.sticky-head{
        position: sticky; top: 0; z-index: 5;
        background: #fff;
        padding-top: 4px;
        border-bottom: 1px solid var(--b);
        margin: -14px -14px 10px;
        padding-left: 14px; padding-right: 14px;
      }
      /* Make action buttons sticky at bottom inside modal */
      .modal .btns.sticky-foot{
        position: sticky; bottom: 0; z-index: 5;
        background:#fff;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
        border-top: 1px solid var(--b);
        margin: 10px -14px -14px;
        padding-left: 14px; padding-right: 14px;
        padding-top: 10px;
      }
    }


    body.modal-open{ overflow:hidden; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“’ í•˜ë£¨ê¸°ë¡</h1>

    <div class="topbar">
      <div class="row">
        <div class="pill">í˜„ì¬ì‹œê°: <strong id="nowTxt">--:--</strong></div>
        <div class="pill">ë‹¤ìŒ ê¸°ë¡ ì‹œì‘(ìë™): <strong id="autoStartTxt">--:--</strong></div>
        <div class="pill">ì•Œë¦¼(ì •ì‹œ): <strong id="notifTxt">OFF</strong></div>
        <button id="btnEnableNotif">ì •ì‹œ ì•Œë¦¼ ì¼œê¸°</button>
        <button id="btnOpen">ì§€ê¸ˆ ê¸°ë¡í•˜ê¸°</button>
      </div>

      <!-- ìˆ˜ë™ ì‹œê°„ ì„¤ì •(ìš”ì²­ ê¸°ëŠ¥) -->
      <div class="card" style="margin-top:10px;">
        <div class="mini">
          <label><input type="checkbox" id="manualTimeToggle" /> ì‹œê°„ ì§ì ‘ ì„¤ì •</label>
          <div class="pill">ì‹œì‘: <strong id="manualStartTxt">ìë™</strong></div>
          <div class="pill">ì¢…ë£Œ: <strong id="manualEndTxt">ìë™</strong></div>
        </div>
        <div class="mini" id="manualTimeInputs" style="display:none; margin-top:10px;">
          <div>
            <label style="margin-bottom:6px;">ì‹œì‘ì‹œê°„</label>
            <input type="time" id="manualStart" />
          </div>
          <div>
            <label style="margin-bottom:6px;">ì¢…ë£Œì‹œê°„</label>
            <input type="time" id="manualEnd" />
          </div>
          <div class="hint">â€¢ ì €ì¥í•  ë•Œ ì´ ì‹œê°„ì´ ì ìš©ë¼ìš”. (ìì • ë„˜ê¹€ë„ ìë™ ì²˜ë¦¬)</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hint">
        âœ… ì‹œê°„ì€ ìë™ìœ¼ë¡œ ê¸°ë¡ë¼ìš”. (íœ´ëŒ€í°/PC ì‹œê³„ ê¸°ì¤€)<br/>
        âœ… ì €ì¥í•˜ë©´ <b>ì´ì „ ì¢…ë£Œ ì‹œê°„ â†’ ì§€ê¸ˆ</b> êµ¬ê°„ìœ¼ë¡œ ì €ì¥ë¼ìš”.<br/>
        âœ… íŒ¨ìŠ¤ëŠ” â€œê¸°ë¡í•  ë‚´ìš© ì—†ìŒâ€ìœ¼ë¡œ, <b>ì‹œê°„ë§Œ ê°±ì‹ </b>ë¼ìš”.<br/>
        âš ï¸ ë‹¨ì¼ HTML íŒŒì¼(file://) í™˜ê²½ì—ì„œëŠ” iOS ì•Œë¦¼ì´ ì œí•œë  ìˆ˜ ìˆì–´ìš”. (í‘œì‹œëŠ” ON/OFF í† ê¸€ ê¸°ì¤€)
      </div>
    </div>

    <table aria-label="ê¸°ë¡í‘œ">
      <thead>
        <tr>
          <th style="width:70px;">ì‹œì‘</th>
          <th style="width:70px;">ì¢…ë£Œ</th>
          <th>ë‚´ìš©</th>
          <th>ì°¸ê³ /ë©”ëª¨</th>
          <th>ë°˜ì„±/ì¹­ì°¬</th>
          <th style="width:70px;">ì†Œìš”</th>
          <th style="width:110px;">ì‘ì—…</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="btns">
      <button id="btnCopy">ğŸ“‹ ê²°ê³¼í‘œ ë³µì‚¬</button>
      <button id="btnExport">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <button id="btnImport">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
      <button id="btnExportCSV">ë‚´ë³´ë‚´ê¸°(CSV)</button>
      <button id="btnImportCSV">ê°€ì ¸ì˜¤ê¸°(CSV)</button>
      <button id="btnClear" class="danger">ì „ì²´ì‚­ì œ</button>
    </div>
    <div class="hint">
      â€¢ â€œê²°ê³¼í‘œ ë³µì‚¬â€ëŠ” ë…¸ì…˜/ë©”ëª¨/ì—‘ì…€ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸°(í‘œ) ê°€ëŠ¥í•´ìš”.<br/>
      â€¢ â€œë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°â€ëŠ” ë°±ì—…/ë³µêµ¬ìš©ì´ì—ìš”.
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-back" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="row sticky-head" style="justify-content:space-between;">
        <h2 id="modalTitle">ğŸ• ì§€ê¸ˆ ê¸°ë¡</h2>
        <button id="btnClose">ë‹«ê¸°</button>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <div class="pill">ì‹œì‘: <strong id="mStart">--:--</strong></div>
        <div class="pill">ì¢…ë£Œ: <strong id="mEnd">--:--</strong></div>
        <div class="pill">ì†Œìš”: <strong id="mDur">--</strong></div>
      </div>

      <div class="mini" id="editTimeBox" style="display:none; margin-bottom:10px;">
        <div>
          <label style="margin-bottom:6px;">ì‹œì‘ì‹œê°„(ìˆ˜ì •)</label>
          <input type="time" id="editStart" />
        </div>
        <div>
          <label style="margin-bottom:6px;">ì¢…ë£Œì‹œê°„(ìˆ˜ì •)</label>
          <input type="time" id="editEnd" />
        </div>
        <div class="hint">â€¢ ìˆ˜ì • ì €ì¥ ì‹œ ì‹œì‘/ì¢…ë£Œ/ì†Œìš”ê°€ í•¨ê»˜ ì—…ë°ì´íŠ¸ë¼ìš”.</div>
      </div>


      <div class="grid">
        <div class="card">
          <label>ë‚´ìš©</label>
          <textarea id="mContent" placeholder="ì˜ˆ) ì½”ë”©, ì„±ê²½í•„ì‚¬, ì¥ë³´ê¸° ..."></textarea>
        </div>
        <div class="card">
          <label>ì°¸ê³  / ë©”ëª¨</label>
          <textarea id="mMemo" placeholder="ì˜ˆ) ë§í¬, ìƒí™© ì„¤ëª…, í•„ìš”í•œ ë©”ëª¨ ..."></textarea>
        </div>
        <div class="card">
          <label>ë°˜ì„± / ì¹­ì°¬</label>
          <textarea id="mReflect" placeholder="ì˜ˆ) ë°˜ì„±: í° ë°©í™© 10ë¶„ ë‚´ë¡œ / ì¹­ì°¬: ì§‘ì¤‘ ì˜í•¨"></textarea>
        </div>
      </div>

      <div class="btns">
        <button id="btnSave" class="primary">ì €ì¥</button>
        <button id="btnPass">íŒ¨ìŠ¤</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const K_LOGS = "mina_daylog_logs_v10";
  const K_LAST = "mina_daylog_last_end_v10";
  const K_NOTIF_ENABLED = "mina_daylog_notif_enabled_v10";

  let logs = [];
  let lastEnd = null; // Date
  let notifEnabled = (localStorage.getItem(K_NOTIF_ENABLED) === "1");
  let editId = null;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(d){ return pad2(d.getHours()) + ":" + pad2(d.getMinutes()); }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

  function durationText(ms){
    const m = Math.max(1, Math.round(ms/60000)); // ìµœì†Œ 1ë¶„
    const h = Math.floor(m/60);
    const mm = m%60;
    if(h===0) return mm + "ë¶„";
    if(mm===0) return h + "ì‹œê°„";
    return h + "ì‹œê°„ " + mm + "ë¶„";
  }

  function parseLast(){
    const s = localStorage.getItem(K_LAST);
    if(!s) return null;
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }
  function saveLast(d){
    lastEnd = d;
    localStorage.setItem(K_LAST, d.toISOString());
    updateHeaderTimes();
  }

  function escapeHtml(s){
    return (s??"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function nl2br(s){ return s.replace(/\n/g,"<br/>"); }

  function persist(){ localStorage.setItem(K_LOGS, JSON.stringify(logs)); }

  function notifStatus(){
    const supported = ("Notification" in window);
    const perm = supported ? Notification.permission : "unsupported";
    return { supported, perm };
  }
  function setNotifPill(){
    const on = notifEnabled === true;
    $("notifTxt").textContent = on ? "ON" : "OFF";
    $("btnEnableNotif").textContent = on ? "ì •ì‹œ ì•Œë¦¼ ë„ê¸°" : "ì •ì‹œ ì•Œë¦¼ ì¼œê¸°";
    const st = notifStatus();
    let tip = "";
    if(!st.supported) tip = "ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.";
    else tip = "ê¶Œí•œ: " + st.perm + " (í‘œì‹œëŠ” í† ê¸€ ON/OFF ê¸°ì¤€)";
    $("notifTxt").title = tip;
  }

  async function toggleNotif(){
    // í† ê¸€ì€ ë¬´ì¡°ê±´ ì‘ë™(í‘œì‹œ ê¸°ì¤€)
    notifEnabled = !notifEnabled;
    localStorage.setItem(K_NOTIF_ENABLED, notifEnabled ? "1" : "0");
    setNotifPill();

    // ì¼¤ ë•Œë§Œ ê¶Œí•œ ìš”ì²­(ê°€ëŠ¥í•œ ê²½ìš°). ì‹¤íŒ¨í•´ë„ í† ê¸€ í‘œì‹œ ìœ ì§€.
    if(notifEnabled){
      const st = notifStatus();
      if(st.supported){
        try{
          const perm = await Notification.requestPermission();
          // title ê°±ì‹ 
          setNotifPill();
          if(perm !== "granted"){
            alert("ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ì–´ìš”. (ì„¤ì •ì—ì„œ ì•Œë¦¼ í—ˆìš© í•„ìš”)");
          }
        }catch(e){
          // ì¡°ìš©íˆ ë¬´ì‹œ
          setNotifPill();
        }
      }
    }
  }

  // ìˆ˜ë™ ì‹œê°„ ì„¤ì • (ìš”ì²­ ê¸°ëŠ¥)
  function manualEnabled(){ return $("manualTimeToggle").checked; }

  function setManualUI(){
    const on = manualEnabled();
    $("manualTimeInputs").style.display = on ? "flex" : "none";
    $("manualStartTxt").textContent = on ? ($("manualStart").value || "--:--") : "ìë™";
    $("manualEndTxt").textContent = on ? ($("manualEnd").value || "--:--") : "ìë™";
  }

  function baseDateFromISO(iso){
    const d = new Date(iso);
    return isNaN(d.getTime()) ? new Date() : d;
  }

  function hhmmFromText(t){
    // expects 'HH:MM'
    if(!t) return "";
    const m = String(t).match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return "";
    return String(m[1]).padStart(2,'0') + ':' + m[2];
  }

  function dateWithTime(baseDate, hhmm){
    const [hh, mm] = hhmm.split(":").map(Number);
    const d = new Date(baseDate);
    d.setHours(hh, mm, 0, 0);
    return d;
  }

  // ìë™ ì‹œì‘ì‹œê°„: ë‚ ì§œê°€ ë°”ë€Œì—ˆê³  ë¹„ì •ìƒì ìœ¼ë¡œ ì»¤ì§€ë©´(18h ì´ˆê³¼) ê°™ì€ ë‚ ì§œì˜ ì‹œê°„ìœ¼ë¡œ ë³´ì •
  function autoStartFor(end){
    if(!lastEnd) return end;
    const s = new Date(lastEnd);
    if(isNaN(s.getTime())) return end;
    if(sameDay(s,end)) return s;
    const diff = end - s;
    if(diff > 18*60*60*1000){
      const adj = new Date(end);
      adj.setHours(s.getHours(), s.getMinutes(), 0, 0);
      if(adj > end) adj.setDate(adj.getDate()-1);
      return adj;
    }
    return s;
  }

  function computeTimesPreview(){
    const endAuto = new Date();
    let start = autoStartFor(endAuto);
    let end = endAuto;

    if(manualEnabled()){
      const ms = $("manualStart").value;
      const me = $("manualEnd").value;
      if(ms && me){
        // ê¸°ì¤€ ë‚ ì§œëŠ” "ì˜¤ëŠ˜"ë¡œ
        start = dateWithTime(endAuto, ms);
        end = dateWithTime(endAuto, me);
        // ìì • ë„˜ê¹€ ì²˜ë¦¬
        if(end < start) end.setDate(end.getDate()+1);
      }
    }
    $("mStart").textContent = fmtTime(start);
    $("mEnd").textContent = fmtTime(end);
    $("mDur").textContent = durationText(end - start);
    return { start, end };
  }

  function updateHeaderTimes(){
    $("nowTxt").textContent = fmtTime(new Date());
    $("autoStartTxt").textContent = lastEnd ? fmtTime(autoStartFor(new Date())) : "--:--";
    setManualUI();
  }

  function openModal(){
    editId = null;
    $("editTimeBox").style.display = "none";
    $("btnSave").textContent = "ì €ì¥";
    $("modalTitle").textContent = "ğŸ• ì§€ê¸ˆ ê¸°ë¡";
    computeTimesPreview();
    $("modalBack").style.display = "flex";
    document.body.classList.add("modal-open");
    setTimeout(()=> $("mContent").focus(), 50);
  }
  function closeModal(){
    $("modalBack").style.display = "none";
    document.body.classList.remove("modal-open");
    $("editTimeBox").style.display = "none";
    $("mContent").value = "";
    $("mMemo").value = "";
    $("mReflect").value = "";
    editId = null;
    $("btnSave").textContent = "ì €ì¥";
    $("modalTitle").textContent = "ğŸ• ì§€ê¸ˆ ê¸°ë¡";
  }

  function addLogFromModal(){
    const { start, end } = computeTimesPreview();
    const row = {
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random()),
      startISO: start.toISOString(),
      endISO: end.toISOString(),
      start: fmtTime(start),
      end: fmtTime(end),
      content: $("mContent").value || "",
      memo: $("mMemo").value || "",
      reflect: $("mReflect").value || "",
      dur: durationText(end - start)
    };
    logs.push(row);
    persist();
    saveLast(end);
    render();
  }

  function doPass(){
    // íŒ¨ìŠ¤ë„ ìˆ˜ë™ ì‹œê°„ì´ ì¼œì ¸ ìˆê³  ì¢…ë£Œì‹œê°„ì´ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ ê¸°ì¤€ì‹œê°„ ê°±ì‹ 
    if(manualEnabled() && $("manualEnd").value){
      const end = dateWithTime(new Date(), $("manualEnd").value);
      saveLast(end);
    }else{
      saveLast(new Date());
    }
    render();
  }

  function delRow(id){
    logs = logs.filter(x=>x.id!==id);
    persist();
    render();
  }

  function startEdit(id){
    const row = logs.find(x=>x.id===id);
    if(!row){ alert("ìˆ˜ì •í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”."); return; }
    editId = id;
    $("modalTitle").textContent = "âœï¸ ê¸°ë¡ ìˆ˜ì •";
    $("btnSave").textContent = "ìˆ˜ì • ì €ì¥";
    $("mContent").value = row.content || "";
    $("mMemo").value = row.memo || "";
    $("mReflect").value = row.reflect || "";
    $("mStart").textContent = row.start || "--:--";
    $("mEnd").textContent = row.end || "--:--";
    $("mDur").textContent = row.dur || "--";
    // ì‹œì‘/ì¢…ë£Œ ì‹œê°„ë„ ìˆ˜ì • ê°€ëŠ¥
    $("editTimeBox").style.display = "flex";
    $("editStart").value = hhmmFromText(row.start);
    $("editEnd").value = hhmmFromText(row.end);
    $("modalBack").style.display = "flex";
    setTimeout(()=> $("mContent").focus(), 50);
  }

    function commitEdit(){
    const idx = logs.findIndex(x=>x.id===editId);
    if(idx < 0){ alert("ìˆ˜ì •í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”."); return; }
    const row = logs[idx];
    row.content = $("mContent").value;
    row.memo = $("mMemo").value;
    row.reflect = $("mReflect").value;

    // ì‹œê°„ ìˆ˜ì •(ì„ íƒ): ì…ë ¥ì´ ìˆìœ¼ë©´ ì‹œì‘/ì¢…ë£Œ/ì†Œìš”ê¹Œì§€ ì—…ë°ì´íŠ¸
    const es = $("editStart").value;
    const ee = $("editEnd").value;
    if(es && ee){
      const base = baseDateFromISO(row.startISO || row.endISO || new Date().toISOString());
      let start = dateWithTime(base, es);
      let end = dateWithTime(base, ee);
      if(end < start) end.setDate(end.getDate()+1); // ìì • ë„˜ê¹€
      row.startISO = start.toISOString();
      row.endISO = end.toISOString();
      row.start = fmtTime(start);
      row.end = fmtTime(end);
      row.dur = durationText(end - start);
      // ë§ˆì§€ë§‰ ê¸°ë¡ì„ ìˆ˜ì •í–ˆë‹¤ë©´ ë‹¤ìŒ ìë™ ì‹œì‘ ê¸°ì¤€ë„ ë§ì¶°ì¤€ë‹¤
      if(idx === logs.length - 1){
        saveLast(end);
      }
    }

    persist();
    render();
    closeModal();
  }

  function render(){
    const tb = $("tbody");
    if(!logs.length){
      tb.innerHTML = `<tr><td colspan="7" class="hint">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. â€œì§€ê¸ˆ ê¸°ë¡í•˜ê¸°â€ë¡œ ì‹œì‘í•´ë´ìš”.</td></tr>`;
      return;
    }
    tb.innerHTML = logs.map(r=>`
      <tr>
        <td data-label="ì‹œì‘">${escapeHtml(r.start)}</td>
        <td data-label="ì¢…ë£Œ">${escapeHtml(r.end)}</td>
        <td data-label="ë‚´ìš©">${nl2br(escapeHtml(r.content))}</td>
        <td data-label="ì°¸ê³ /ë©”ëª¨">${nl2br(escapeHtml(r.memo))}</td>
        <td data-label="ë°˜ì„±/ì¹­ì°¬">${nl2br(escapeHtml(r.reflect))}</td>
        <td data-label="ì†Œìš”">${escapeHtml(r.dur)}</td>
        <td class="right" data-label="ì‘ì—…">
          <button data-edit="${r.id}">ìˆ˜ì •</button>
          <button data-del="${r.id}">ì‚­ì œ</button>
        </td>
      </tr>
    `).join("");

    tb.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        if(confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) delRow(id);
      });
    });
    tb.querySelectorAll("button[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-edit");
        startEdit(id);
      });
    });
  }

    async function copyTableForNotion(){
    if(!logs.length){ alert("ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ì–´ìš”."); return; }
    // ë…¸ì…˜ì— ë¶™ì—¬ë„£ê¸° ìµœì : â‘  HTML table â‘¡ TSV(plain) ë‘˜ ë‹¤ í´ë¦½ë³´ë“œì— ë„£ê¸°
    const headers = ["ì‹œì‘","ì¢…ë£Œ","ë‚´ìš©","ì°¸ê³  / ë©”ëª¨","ë°˜ì„± ë° ì¹­ì°¬","ì†Œìš”"];

    const cellPlain = (v)=> String(v||"")
      .replace(/\t/g," ")
      .replace(/\r?\n/g," ");
    const cellHtml = (v)=> escapeHtml(String(v||"")).replace(/\r?\n/g,"<br/>");

    // TSV (plain)
    let tsv = headers.join("\t") + "\n";
    logs.forEach(x=>{
      tsv += [x.start, x.end, cellPlain(x.content), cellPlain(x.memo), cellPlain(x.reflect), cellPlain(x.dur)].join("\t") + "\n";
    });

    // HTML table
    let htmlTable = "<table><thead><tr>" + headers.map(h=>"<th>"+h+"</th>").join("") + "</tr></thead><tbody>";
    logs.forEach(x=>{
      htmlTable += "<tr>" +
        "<td>"+escapeHtml(x.start||"")+"</td>" +
        "<td>"+escapeHtml(x.end||"")+"</td>" +
        "<td>"+cellHtml(x.content)+"</td>" +
        "<td>"+cellHtml(x.memo)+"</td>" +
        "<td>"+cellHtml(x.reflect)+"</td>" +
        "<td>"+escapeHtml(x.dur||"")+"</td>" +
      "</tr>";
    });
    htmlTable += "</tbody></table>";

    try{
      if(navigator.clipboard && window.ClipboardItem){
        const item = new ClipboardItem({
          "text/plain": new Blob([tsv], {type:"text/plain"}),
          "text/html": new Blob([htmlTable], {type:"text/html"})
        });
        await navigator.clipboard.write([item]);
      }else{
        await navigator.clipboard.writeText(tsv);
      }
      alert("ë…¸ì…˜ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥! (ê²°ê³¼í‘œ ë³µì‚¬ ì™„ë£Œ)");
    }catch(e){
      // iOS ë“±ì—ì„œ ê¶Œí•œ/ì§€ì› ë¬¸ì œ ì‹œ fallback
      try{ await navigator.clipboard.writeText(tsv); alert("ë…¸ì…˜ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥! (í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬ ì™„ë£Œ)"); }
      catch(_){ prompt("ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ë…¸ì…˜ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”:", tsv); }
    }
  }

  async function exportJSON(){
    const data = { version: 10, exportedAt: new Date().toISOString(), lastEndISO: lastEnd ? lastEnd.toISOString() : null, logs };
    const text = JSON.stringify(data, null, 2);
    try{
      await navigator.clipboard.writeText(text);
      alert("ë°±ì—… JSONì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”. ë…¸ì…˜/ë©”ëª¨ì— ë¶™ì—¬ë„£ì–´ ì €ì¥í•´ë‘ì„¸ìš”.");
    }catch(e){
      prompt("ì•„ë˜ JSONì„ ë³µì‚¬í•´ì„œ ì €ì¥í•´ë‘ì„¸ìš”:", text);
    }
  }

  function importJSON(){
    const raw = prompt("ë°±ì—… JSONì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:");
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if(!data || !Array.isArray(data.logs)) throw new Error("í˜•ì‹ ì˜¤ë¥˜");
      logs = data.logs;
      persist();
      const le = data.lastEndISO ? new Date(data.lastEndISO) : null;
      if(le && !isNaN(le.getTime())) saveLast(le);
      render();
      alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
    }catch(e){
      alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ì„ í™•ì¸í•´ì¤˜ìš”.");
    }

  function csvEscape(v){
    const s = String(v ?? "");
    // Quote if contains comma, quote, or newline
    if(/[",\r\n]/.test(s)){
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  function toCSV(){
    const headers = ["ì‹œì‘","ì¢…ë£Œ","ë‚´ìš©","ì°¸ê³ /ë©”ëª¨","ë°˜ì„±/ì¹­ì°¬","ì†Œìš”"];
    let csv = headers.map(csvEscape).join(",") + "\n";
    logs.forEach(x=>{
      const row = [
        x.start || "",
        x.end || "",
        x.content || "",
        x.memo || "",
        x.reflect || "",
        x.dur || ""
      ];
      csv += row.map(csvEscape).join(",") + "\n";
    });
    return csv;
  }

  async function exportCSV(){
    if(!logs.length){ alert("ë‚´ë³´ë‚¼ ê¸°ë¡ì´ ì—†ì–´ìš”."); return; }
    const csv = toCSV();
    // Prefer file download if possible; fallback to clipboard/prompt
    try{
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const d = new Date();
      const name = `í•˜ë£¨ê¸°ë¡_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}.csv`;
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
      alert("CSV íŒŒì¼ë¡œ ë‚´ë³´ëƒˆì–´ìš”. (ë‹¤ìš´ë¡œë“œ)"); 
    }catch(e){
      try{
        await navigator.clipboard.writeText(csv);
        alert("CSVë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”. ì—‘ì…€/ì‹œíŠ¸/ë…¸ì…˜ì— ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥!");
      }catch(_){
        prompt("ì•„ë˜ CSVë¥¼ ë³µì‚¬í•´ì„œ ì €ì¥í•´ë‘ì„¸ìš”:", csv);
      }
    }
  }

  function parseCSV(text){
    // Simple RFC4180-ish parser (supports quoted fields with commas/newlines)
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    while(i < text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        }else{
          field += c; i++; continue;
        }
      }else{
        if(c === '"'){ inQuotes = true; i++; continue; }
        if(c === ','){ row.push(field); field=""; i++; continue; }
        if(c === '\n'){
          row.push(field); field="";
          // ignore empty last line
          if(row.length && !(row.length===1 && row[0]==="")) rows.push(row);
          row=[]; i++; continue;
        }
        if(c === '\r'){ i++; continue; }
        field += c; i++; continue;
      }
    }
    row.push(field);
    if(row.length && !(row.length===1 && row[0]==="")) rows.push(row);
    return rows;
  }

  function importCSV(){
    const raw = prompt("CSV ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:\n(ì²« ì¤„ì€ í—¤ë”: ì‹œì‘,ì¢…ë£Œ,ë‚´ìš©,ì°¸ê³ /ë©”ëª¨,ë°˜ì„±/ì¹­ì°¬,ì†Œìš”)");
    if(!raw) return;
    try{
      const rows = parseCSV(raw.trim());
      if(rows.length < 2){ throw new Error("rows"); }
      // Expect header in first row; map columns by header text
      const header = rows[0].map(s=>String(s).trim());
      const idx = (name)=> header.findIndex(h=>h.replace(/\s+/g,"") === name.replace(/\s+/g,""));
      const iStart = idx("ì‹œì‘");
      const iEnd = idx("ì¢…ë£Œ");
      const iContent = idx("ë‚´ìš©");
      const iMemo = idx("ì°¸ê³ /ë©”ëª¨") >= 0 ? idx("ì°¸ê³ /ë©”ëª¨") : idx("ì°¸ê³ /ë©”ëª¨");
      const iReflect = idx("ë°˜ì„±/ì¹­ì°¬");
      const iDur = idx("ì†Œìš”");
      if(iStart<0 || iEnd<0 || iContent<0){ throw new Error("header"); }

      // Convert rows to logs; times are HH:MM strings. We do not reconstruct exact dates; keep display times and recompute ISO using today.
      const today = new Date();
      const newLogs = [];
      for(let r=1; r<rows.length; r++){
        const cols = rows[r];
        const startTxt = (cols[iStart] ?? "").trim();
        const endTxt = (cols[iEnd] ?? "").trim();
        const content = cols[iContent] ?? "";
        const memo = (iMemo>=0 ? cols[iMemo] : "") ?? "";
        const reflect = (iReflect>=0 ? cols[iReflect] : "") ?? "";
        const dur = (iDur>=0 ? cols[iDur] : "") ?? "";

        // Build ISO roughly for ordering (today base). If invalid, skip row.
        if(!/^\d{1,2}:\d{2}$/.test(startTxt) || !/^\d{1,2}:\d{2}$/.test(endTxt)) continue;
        let startD = dateWithTime(today, startTxt.padStart(5,"0"));
        let endD = dateWithTime(today, endTxt.padStart(5,"0"));
        if(endD < startD) endD.setDate(endD.getDate()+1);

        newLogs.push({
          id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random()),
          startISO: startD.toISOString(),
          endISO: endD.toISOString(),
          start: startTxt.padStart(5,"0"),
          end: endTxt.padStart(5,"0"),
          content,
          memo,
          reflect,
          dur: dur || durationText(endD - startD)
        });
      }
      if(!newLogs.length) throw new Error("empty");
      logs = newLogs;
      persist();
      // lastEnd = end of last row
      const le = new Date(logs[logs.length-1].endISO);
      if(!isNaN(le.getTime())) saveLast(le);
      render();
      alert("CSV ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
    }catch(e){
      alert("CSV ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: í˜•ì‹ì„ í™•ì¸í•´ì¤˜ìš”.");
    }
  }
  }

  function clearAll(){
    if(!confirm("ì „ì²´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”)")) return;
    logs = [];
    persist();
    saveLast(new Date());
    render();
  }

  function load(){
    try{ logs = JSON.parse(localStorage.getItem(K_LOGS) || "[]") || []; }catch(e){ logs = []; }
    lastEnd = parseLast();
    if(!lastEnd) saveLast(new Date());
    render();
    updateHeaderTimes();
    setNotifPill();
  }

  // ì •ì‹œ ì•Œë¦¼/íŒì—… (í˜ì´ì§€ ì—´ë ¤ ìˆì„ ë•Œ)
  let lastHourFired = null;
  function tick(){
    updateHeaderTimes();
    const d = new Date();
    if(d.getMinutes()===0){
      const key = d.getFullYear()+"-"+d.getMonth()+"-"+d.getDate()+"-"+d.getHours();
      if(lastHourFired !== key){
        lastHourFired = key;
        if(notifEnabled && ("Notification" in window) && Notification.permission==="granted"){
          try{ new Notification("í•˜ë£¨ê¸°ë¡", { body: "ì •ì‹œ ê¸°ë¡í•  ì‹œê°„ì´ì—ìš”." }); }catch(e){}
        }
        openModal();
      }
    }
  }

  // Wire (ë²„íŠ¼ ì‘ë™ í™•ì‹¤)
  $("btnOpen").addEventListener("click", openModal);
  $("btnClose").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeModal(); });

  $("btnSave").addEventListener("click", ()=>{
    if(editId){ commitEdit(); return; }
    addLogFromModal();
    closeModal();
  });
  $("btnPass").addEventListener("click", ()=>{ doPass(); closeModal(); });

  $("btnCopy").addEventListener("click", copyTableForNotion);
  $("btnExport").addEventListener("click", exportJSON);
  $("btnImport").addEventListener("click", importJSON);
  $("btnClear").addEventListener("click", clearAll);

  $("btnExportCSV").addEventListener("click", exportCSV);
  $("btnImportCSV").addEventListener("click", importCSV);

  $("btnEnableNotif").addEventListener("click", toggleNotif);

  $("manualTimeToggle").addEventListener("change", ()=>{ setManualUI(); computeTimesPreview(); });
  $("manualStart").addEventListener("change", ()=>{ setManualUI(); computeTimesPreview(); });
  $("manualEnd").addEventListener("change", ()=>{ setManualUI(); computeTimesPreview(); });

  // Start
  load();
  document.addEventListener("visibilitychange", ()=>{ setNotifPill(); updateHeaderTimes(); });
  setInterval(tick, 1000);
})();
</script>
</body>
</html>
